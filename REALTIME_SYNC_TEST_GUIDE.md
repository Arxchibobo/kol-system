# 实时同步功能测试指南

## ✅ 功能说明

系统已实现完整的实时同步功能，支持：

1. **跨用户同步**：用户 A 创建的任务，用户 B 可以看到
2. **同账号跨设备同步**：同一账号在不同浏览器/设备登录，操作会实时同步
3. **自动轮询**：每 10 秒自动从后端数据库获取最新数据

## 🔄 工作原理

### 数据流向

```
任何操作（创建/编辑/删除）
    ↓
先保存到后端数据库（SQLite）
    ↓
更新当前用户本地缓存
    ↓
其他用户/设备每 10 秒自动轮询
    ↓
从后端数据库获取最新数据
    ↓
所有用户看到一致的数据
```

### 关键实现

1. **后端优先策略** (services/mockStore.ts)
   - `getTasks()`: 优先从 `/api/tasks` 获取
   - `createTask()`: POST `/api/tasks` 保存到数据库
   - `updateTask()`: PUT `/api/tasks/:id` 更新数据库
   - `deleteTask()`: DELETE `/api/tasks/:id` 从数据库删除

2. **自动轮询机制** (components/AdminDashboard.tsx:153-170)
   ```typescript
   useEffect(() => {
     console.log('🔄 启动自动同步，每 10 秒刷新一次');
     handleRefreshAll(); // 立即刷新一次

     const intervalId = setInterval(() => {
       console.log('⏰ 自动刷新任务列表...');
       handleRefreshAll();
     }, 10000); // 10 秒

     return () => clearInterval(intervalId); // 清理定时器
   }, []);
   ```

3. **同步状态指示器**
   - 🟢 绿色圆点 + "实时同步" = 系统空闲
   - 🟡 黄色脉动圆点 + "同步中..." = 正在同步数据
   - 显示 "(每 10 秒)" 提示自动刷新频率

## 🧪 测试场景

### 场景 1: 同账号跨浏览器测试

**步骤：**

1. **设备 A（Chrome）**
   - 打开 `http://localhost:5173`
   - 使用邮箱 `admin@myshell.ai` 登录运营后台
   - 观察右上角显示 "实时同步 (每 10 秒)"

2. **设备 B（Firefox/其他电脑）**
   - 打开 `http://localhost:5173`
   - 使用**相同邮箱** `admin@myshell.ai` 登录
   - 同样观察到 "实时同步 (每 10 秒)"

3. **在设备 A 创建新任务**
   - 点击 "Create New Task"
   - 填写任务信息：
     - 标题：`跨设备同步测试 ${new Date().getTime()}`
     - 描述：测试内容
     - 产品链接：https://example.com
   - 点击保存
   - 观察控制台日志：`💾 正在保存任务到后端...`
   - 观察任务立即出现在设备 A 的列表中

4. **在设备 B 观察**
   - 等待最多 10 秒
   - 观察右上角指示器变为黄色 "同步中..."
   - 观察控制台日志：`⏰ 自动刷新任务列表...`
   - 观察控制台日志：`✅ 从后端成功获取 X 个任务`
   - **任务自动出现在设备 B 的列表中**

5. **在设备 B 编辑任务**
   - 点击刚才创建的任务的编辑按钮
   - 修改标题为：`跨设备同步测试 - 已编辑`
   - 保存修改
   - 观察控制台：`🔄 正在更新任务到后端...`

6. **在设备 A 观察**
   - 等待最多 10 秒
   - 观察任务标题自动更新为 "已编辑" 版本

7. **在设备 A 删除任务**
   - 点击删除按钮
   - 确认删除
   - 观察控制台：`🗑️ 正在从后端删除任务...`
   - 任务立即从设备 A 消失

8. **在设备 B 观察**
   - 等待最多 10 秒
   - 观察任务自动从列表中消失

### 场景 2: 跨用户同步测试

**步骤：**

1. **用户 A（admin@myshell.ai）**
   - 登录运营后台
   - 创建任务 "Ugly Sweater Challenge"

2. **用户 B（另一个运营账号）**
   - 登录运营后台
   - 等待 10 秒自动刷新
   - 可以看到用户 A 创建的 "Ugly Sweater Challenge"

### 场景 3: 网络故障降级测试

**步骤：**

1. 正常情况下创建几个任务
2. 停止后端服务器（`npm run server`）
3. 在前端尝试创建新任务
4. 观察控制台警告：`⚠️ 保存任务到后端失败`
5. 任务仍然保存到本地 localStorage
6. 重启后端服务器
7. 等待 10 秒自动刷新
8. 观察系统恢复正常，所有设备数据同步

## 📊 控制台日志说明

### 正常同步日志

```
🔄 启动自动同步，每 10 秒刷新一次
🔄 正在从后端获取任务列表...
✅ 从后端成功获取 3 个任务
⏰ 自动刷新任务列表...
🔄 正在从后端获取任务列表...
✅ 从后端成功获取 3 个任务
```

### 创建任务日志

```
💾 正在保存任务到后端...
✅ 任务已成功保存到后端: Ugly Sweater Challenge
```

### 更新任务日志

```
🔄 正在更新任务到后端...
✅ 任务已成功更新到后端: Ugly Sweater Challenge
```

### 删除任务日志

```
🗑️ 正在从后端删除任务...
✅ 任务已成功从后端删除: Ugly Sweater Challenge
[MockStore] 删除任务: Ugly Sweater Challenge (t-1234567890-123)
[MockStore] 删除了 5 条达人任务记录
```

### 后端故障降级日志

```
⚠️ 从后端获取任务失败，使用本地缓存: TypeError: Failed to fetch
📦 使用本地缓存，共 3 个任务
```

## ⚙️ 配置说明

### 修改同步频率

如需调整自动刷新频率，修改 `components/AdminDashboard.tsx:162`：

```typescript
}, 10000); // 改为 5000 = 5 秒，15000 = 15 秒
```

### 禁用自动同步

如需禁用自动同步（仅手动刷新），注释掉 `components/AdminDashboard.tsx:152-170` 的 useEffect。

## 🐛 故障排查

### 问题 1: 数据不同步

**检查项：**
1. 后端服务器是否运行？(`npm run server`)
2. 浏览器控制台是否有错误？
3. 是否看到 "⏰ 自动刷新任务列表..." 日志？
4. 网络请求是否成功？（浏览器 Network 标签）

### 问题 2: 同步延迟超过 10 秒

**可能原因：**
1. 网络延迟
2. 后端服务器响应慢
3. 浏览器标签页被挂起（切换回来会立即刷新）

### 问题 3: 创建/编辑/删除失败

**检查项：**
1. 后端 API 是否正常工作？
2. 数据库连接是否正常？
3. 查看控制台详细错误信息

## 📝 技术细节

### 数据持久化层级

1. **第一层：后端数据库（SQLite）**
   - 路径：`backend/database.sqlite`
   - 表：`tasks`, `tracking_links`, `clicks`
   - 作用：所有设备的唯一真实数据源

2. **第二层：前端 localStorage**
   - 键：`myshell_affiliate_data`
   - 作用：离线缓存，提升加载速度
   - 刷新策略：每次从后端获取后更新

### 同步保证

- **最终一致性**：所有设备在 10 秒内达到数据一致
- **乐观更新**：本地操作立即生效，后台异步同步
- **降级策略**：后端不可用时使用本地缓存

### 并发冲突处理

当前实现：**后写入覆盖** (Last Write Wins)
- 用户 A 和 B 同时编辑同一任务
- 后提交的修改会覆盖先提交的
- 所有用户在下次刷新后看到最新版本

未来可优化：
- 添加版本号或时间戳
- 实现冲突检测和合并策略
- 使用 WebSocket 实现真正的实时推送

## ✅ 验收标准

- [x] 同账号不同浏览器创建任务，10 秒内其他浏览器可见
- [x] 同账号不同设备编辑任务，10 秒内其他设备看到修改
- [x] 同账号任意设备删除任务，10 秒内所有设备任务消失
- [x] 跨用户操作可以互相看到
- [x] UI 显示实时同步状态指示器
- [x] 后端故障时系统降级到本地缓存
- [x] 控制台日志清晰显示同步过程
- [x] 刷新按钮 tooltip 提示自动刷新机制

## 🎉 总结

当前实现已经完全支持：

✅ **同一账号在不同地方登录时的实时同步**
✅ **跨用户的实时同步**
✅ **自动轮询 + 手动刷新**
✅ **可视化同步状态指示器**
✅ **完善的错误处理和降级机制**

测试时请确保后端服务器运行（`npm run server`），然后按照上述场景进行验证！
